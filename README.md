# Kotlin_Flow_To_The_View
PoC using Flow to the View on an Android Project. 

TL;DR : 

|                             |                                       Flow with `.asLiveData()`<br />or `liveData {}`                                       |                                                                               Flow with `.stateIn()`                                                                               |                                              `viewModelScope.launch()` with `MutableLiveData` field                                              |   |
|-----------------------------|:---------------------------------------------------------------------------------------------------------------------------:|:----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------:|:------------------------------------------------------------------------------------------------------------------------------------------------:|:-:|
| ViewModelScope              |                                                              ✔️                                                              |                                                                                          ✔️                                                                                         |                                                                         ✔️                                                                        |   |
| Lifecycle                   |                                ✔️<br />Suspended after `Activity` is stopped for 5s (default)                                |                                                                  ✔️<br />Suspended after `SharingStarted`'s timeout                                                                 |                                  ❌<br />Resources will be wasted (but no crash) as soon as `Activity` is stopped                                 |   |
| Republish content on rebind |                                                             ✔️ No                                                            |                                                           ❌ Yes (need `distinctUntilChanged()` before `collect` on View)                                                           |                                                                       ✔️ No                                                                       |   |
| Adjustable Timeout          |                                                ✔️<br />`timeoutInMs` parameter                                               |                                             ✔️<br />`stopTimeoutMillis` of `SharingStarted.WhileSubscribed` value for started parameter                                             |                                                                         ❌                                                                        |   |
| On timeout (5s) behavior    |                                            Restarts only if Flow didn't complete¹                                            |                          Restarts only if Flow didn't complete¹<br />or always exposes initial state and restarts Flow (with `replayExpirationMillis = 0`)                          |                                                                         ❌                                                                        |   |
| Adjustable Initial state    |       ✔️<br />Must expose initial state manually (can use `latestValue` to check if a previous value has been emitted)       |                                                     ✔️✔️<br />Initial state is exposed automatically when coroutine is restarted                                                     |                                                                         ❌                                                                        |   |
| Dynamic Initial state       |                                                ✔️<br />Can change arbitrarily                                                |                                                                 ❌<br />Initial state can't change between timeouts                                                                 |                                                                         ❌                                                                        |   |
| Unit Testing                |               ✔️<br />Must inject `Dispatchers`<br />Must use `TestCoroutineScope` & `InstantTaskExecutorRule`               |                                          ✔️<br />Must inject `Dispatchers` and `SharingStarted` strategy<br />Must use `TestCoroutineScope`                                         |                          ✔️<br />Must inject `Dispatchers`<br />Must use `TestCoroutineScope` & `InstantTaskExecutorRule`                         |   |
| Boilerplate                 | ✔️✔️<br />2 lines:<br />field `.asLiveData(dispatchers.io)`<br />or `liveData(dispatchers.io) {}`<br />injected `Dispatchers` | ❌<br />4 to 6 lines:<br />`.stateIn()`<br />shared parameter<br />scope parameter<br />initial value parameter<br />injected `Dispatchers`<br />injected `SharingStarted` strategy | ❌<br />4 to 5 lines:<br />private MutableLiveData field<br />LiveData getter<br />init {}<br />viewModelScope.launch<br />injected `Dispatchers` |   |
| Complexity / Error prone    |                                                              ✔️                                                              |                                                                                          ❌                                                                                         |                                                                         ✔️                                                                        |   |
| LiveData dependency         |                                                              ❌                                                              |                                                                                          ✔️                                                                                         |                                                                         ❌                                                                        |   |

**¹** : If a hot flow (*Mutable*StateFlow, *Mutable*SharedFlow, Channel, etc...) is used to produce values downstream, the flow will never complete !   
This means the `collect` will restart after the 5s timeout, even if it would seem unnecessary.  
[More information here](https://bladecoder.medium.com/kotlins-flow-in-viewmodels-it-s-complicated-556b472e281a#:~:text=Using%20StateFlow%20as%20trigger%20in%20a%20ViewModel)

Using `.asLiveData()` extension, `liveData()` function or `.stateIn()` extension is a better approach than simply launching on the `viewModelScope` to publish to a `MutableLiveData` or `MutableStateFlow`. This is because when using `.asLiveData()`, `liveData()` or `stateIn()`, the coroutine is cancelled 5 seconds after leaving the Activity (not killing the application, just pressing 'home' or 'recent apps' button !), avoiding possibly unnecessary work. 

There is one way to go with pure Kotlin, meaning there's no need for LiveData dependencies, but **I wouldn't recommend it at the time**, because any hot flow (see **¹**) will make your collection restart after a timeout. Using a `MutableLiveData` with a `switchMap()` operator to "trigger" a flow is the only viable option to this day. Also, unit testing is a bit more complicated (one needs to inject both `Dispatchers` and `SharingStarted` strategy). And, to my opinion, it's more error prone. 

See for yourself in the project, both "pure Kotlin" and LiveData approach are used ! 

Inspired by : 
https://medium.com/androiddevelopers/a-safer-way-to-collect-flows-from-android-uis-23080b1f8bda
